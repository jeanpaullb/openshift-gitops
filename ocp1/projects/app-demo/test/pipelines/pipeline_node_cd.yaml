apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: pipeline-node-cd
spec:
  params:
    - name: APP_NAME
      default: app-ui
      type: string
    - name: PROJECT_NAME
      default: app-demo-test
      type: string
    - name: GIT_REPOSITORY
      default: 'git@github.com:SancorSalud/example.git'
      type: string
    - name: GIT_BRANCH
      default: app-ui
      type: string
    - name: CONTEXT_PATH
      default: '.'
      type: string
    - default: '1.0.0-SNAPSHOT'
      name: TAG_IMAGE
      type: string
  tasks:
    # Obtiene el codigo fuente de la applicacion
    - name: checkout
      taskRef:
        kind: ClusterTask
        name: git-clone
      params:
        - name: url
          value: $(params.GIT_REPOSITORY)
        - name: revision
          value: $(params.GIT_BRANCH)
        - name: subdirectory
          value: ""
        - name: deleteExisting
          value: "true"
      workspaces:
        - name: output
          workspace: source-code
    # Compila la imagen docker y la pushea a la registry
    - name: build
      runAfter:
        - checkout
      taskRef:
        kind: ClusterTask
        name: s2i-nodejs
      params:
        - name: VERSION
          value: 14-ubi8
        - name: PATH_CONTEXT
          value: $(params.CONTEXT_PATH)
        - name: TLSVERIFY
          value: 'false'
        - name: IMAGE
          value: >-
            image-registry.openshift-image-registry.svc:5000/$(params.PROJECT_NAME)/$(params.APP_NAME):$(params.TAG_IMAGE)
        - name: BUILDER_IMAGE
          value: >-
            registry.redhat.io/rhel8/buildah@sha256:e19cf23d5f1e0608f5a897f0a50448beb9f8387031cca49c7487ec71bd91c4d3
      workspaces:
        - name: source
          workspace: source-code
    # Despliega en desarrollo un overlay de kustomize
    - name: deploy
      params:
        - name: application-name
          value: $(params.APP_NAME)
        - name: environment
          value: dev
        - name: flags
          value: '--insecure'
        - name: image
          value: >-
            image-registry.openshift-image-registry.svc:5000/$(params.PROJECT_NAME)/$(params.APP_NAME):$(params.TAG_IMAGE)
      runAfter:
        - build
      taskRef:
        kind: ClusterTask
        name: redhat-argocd-kustomize-sync
  workspaces:
    - name: source-code
