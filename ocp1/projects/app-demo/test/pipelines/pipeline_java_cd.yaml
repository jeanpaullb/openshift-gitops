apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  annotations:
    description: Pipeline Java CD
    openshift.io/display-name: Sancor Pipeline Java CD
    openshift.io/provider-display-name: SanCor
  name: pipeline-java-cd
spec:
  params:
  - name: APP_NAME
    type: string
    default: app-api
  - name: PROJECT_NAME
    type: string
    default: app-demo-test
  - name: GIT_APP_REPOSITORY
    type: string
    default: 'git@github.com:SancorSalud/example.git'
  - name: GIT_APP_BRANCH
    type: string
    default: springboot
  - name: GIT_GITOPS_REPOSITORY
    type: string
    default: 'git@github.com:SancorSalud/example-gitops.git'
  - name: GIT_GITOPS_BRANCH
    type: string
    default: master
  - name: CONTEXT_PATH
    type: string
    default: .
  workspaces:
  - name: source-code
  - name: maven-settings
  - name: maven-local-repo
  - name: sonar-secret
  - name: trivy-db-cache
  tasks:

  - name: checkout
    taskRef:
      kind: ClusterTask
      name: git-clone
    params:
    - name: url
      value: $(params.GIT_APP_REPOSITORY)
    - name: revision
      value: $(params.GIT_APP_BRANCH)
    - name: subdirectory
      value: ''
    - name: deleteExisting
      value: 'true'
    - name: sslVerify
      value: 'false'
    workspaces:
    - name: output
      workspace: source-code

  - name: compile
    taskRef:
      kind: ClusterTask
      name: redhat-maven
    runAfter:
    - checkout
    params:
    - name: MAVEN_IMAGE
      value: 'maven:3.8-openjdk-17'
    - name: CONTEXT_DIR
      value: $(params.CONTEXT_PATH)
    - name: GOALS
      value:
      - package
      - '-DskipTests=true'
    workspaces:
    - name: source
      workspace: source-code
    - name: maven-settings
      workspace: maven-settings
    - name: maven-local-repo
      workspace: maven-local-repo

  - name: static-code-analysis
    taskRef:
      kind: ClusterTask
      name: redhat-static-code-sonar
    runAfter:
    - compile
    params:
    - name: MAVEN_IMAGE
      value: 'maven:3.8-openjdk-17'
    - name: CONTEXT_PATH
      value: $(params.CONTEXT_PATH)
    - name: SONAR_URL
      value: 'http://ams01-sonarqube.sonarqube.svc:9000/'
    - name: PROJECT_KEY
      value: $(params.APP_NAME)
    workspaces:
    - name: source-code
      workspace: source-code
    - name: sonar-secret
      workspace: sonar-secret
    - name: maven-settings
      workspace: maven-settings
    - name: maven-local-repo
      workspace: maven-local-repo

  # Obtiene la version de maven en el pom
  - name: get-maven-version
    taskRef:
      kind: ClusterTask
      name: get-maven-version
    runAfter:
    - static-code-analysis
    params:
    - name: MAVEN_IMAGE
      value: maven:3.8.1-jdk-11
    - name: CONTEXT_PATH
      value: $(params.CONTEXT_PATH)
    workspaces:
    - name: source-code
      workspace: source-code
    - name: maven-settings
      workspace: maven-settings
    - name: maven-local-repo
      workspace: maven-local-repo

  # Obtiene la version de maven en el pom
  - name: release
    taskRef:
      kind: ClusterTask
      name: release
    runAfter:
    - get-maven-version
    params:
    - name: application-name
      value: $(params.APP_NAME)
    - name: project
      value: $(params.PROJECT_NAME)
    - name: git-app-repository-url
      value: $(params.GIT_APP_REPOSITORY)
    - name: git-app-repository-branch
      value: $(params.GIT_APP_BRANCH)
    - name: git-gitops-repository-url
      value: $(params.GIT_GITOPS_REPOSITORY)
    - name: git-gitops-repository-branch
      value: $(params.GIT_GITOPS_BRANCH)
    - name: release
      value: $(tasks.get-maven-version.results.version)
    - name: overlay-yaml-file
      value: ./$(params.APP_NAME)/openshift/overlays/test/patch-deployment.yaml
    - name: verbose
      value: 'true'

  - name: build-push-image
    params:
      - name: VERSION
        value: '17'
      - name: PATH_CONTEXT
        value: $(workspaces.source.path)/target
      - name: IMAGE
        value: >-
          image-registry.openshift-image-registry.svc:5000/$(params.PROJECT_NAME)/$(params.APP_NAME):$(tasks.get-maven-version.results.version)
    runAfter:
      - release
    taskRef:
      kind: ClusterTask
      name: redhat-s2i-java
    workspaces:
      - name: source
        workspace: source-code

  - name: trivy-scan
    taskRef:
      kind: ClusterTask
      name: trivy-scan
    runAfter:
    - build-push-image
    params:
      - name: image
        value: >-
          image-registry.openshift-image-registry.svc:5000/$(params.PROJECT_NAME)/$(params.APP_NAME):$(tasks.get-maven-version.results.version)
      - name: project
        value: $(params.PROJECT_NAME)
    workspaces:
    - name: trivy-db-cache
      workspace: trivy-db-cache

  - name: deploy
    taskRef:
      kind: ClusterTask
      name: argocd-branch-sync
    runAfter:
    - trivy-scan
    params:
      - name: application-name
        value: $(params.APP_NAME)-test
      - name: flags
        value: '--insecure'
      - name: target-branch
        value: $(tasks.get-maven-version.results.version)
